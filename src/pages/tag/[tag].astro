---
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostCard from '../../components/PostCard.astro';
import PageHeader from '../../components/PageHeader.astro';
import StructuredData from '../../components/StructuredData.astro';
import { getCollection } from 'astro:content';
import { generateStructuredData } from '../../utils/structuredData';
import { generateKeywords } from '../../utils/seo';

export async function getStaticPaths() {
	const posts = await getCollection('blog');
	const tags = new Set<string>();
	
	posts.forEach(post => {
		post.data.tags?.forEach(tag => tags.add(tag));
	});

	return Array.from(tags).map(tag => ({
		params: { tag },
		props: { tag },
	}));
}

const { tag } = Astro.props;

// Get all posts with this tag
const posts = await getCollection('blog', ({ data }) => {
	return import.meta.env.PROD ? !data.draft : true;
});

// Filter posts by tag
const tagPosts = posts
	.filter(post => post.data.tags?.includes(tag))
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Generate structured data
const structuredData = generateStructuredData({
	title: `${tag} - Tag`,
	description: `Browse all posts tagged with ${tag}`,
	path: `/tag/${tag}`,
	posts: tagPosts,
	type: 'tag',
	identifier: tag,
	author: 'Antoniwan'
});

// Auto-generate keywords
const keywords = generateKeywords([tag], []);
---

<BaseLayout
	title={`${tag} - Tag`}
	description={`Browse all posts tagged with ${tag}`}
	path={`/tag/${tag}`}
	keywords={keywords}
>
	<!-- Structured Data -->
	<StructuredData data={structuredData} />
	
	<div class="w-full px-4 md:px-6 lg:px-8 xl:px-12">
		{/* Tag Header */}
		<div class="max-w-container mx-auto">
			<PageHeader 
				title={`#${tag}`}
				description={`Browse all posts tagged with ${tag}`}
			/>
			
			{/* Tag Posts */}
			<div class="space-y-8 mt-12">
				{tagPosts.map(post => (
					<PostCard post={post} />
				))}
			</div>
			
			{/* Empty State */}
			{tagPosts.length === 0 && (
				<div class="text-center py-12">
					<p class="text-neutral-600 dark:text-neutral-400">
						No posts found with this tag yet.
					</p>
				</div>
			)}
		</div>
	</div>
</BaseLayout>

<style>
	/* Smooth transitions for dark mode */
	main {
		transition: background-color 300ms cubic-bezier(0.4, 0, 0.2, 1),
					color 300ms cubic-bezier(0.4, 0, 0.2, 1);
	}

	/* Respect reduced motion preferences */
	@media (prefers-reduced-motion: reduce) {
		main {
			transition: none !important;
		}
	}
</style> 