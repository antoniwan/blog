---
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostCard from '../../components/PostCard.astro';
import Section from '../../components/Section.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
	const posts = await getCollection('blog');
	const tags = new Set<string>();
	
	posts.forEach(post => {
		post.data.tags?.forEach(tag => tags.add(tag));
	});

	return Array.from(tags).map(tag => ({
		params: { tag },
		props: { tag },
	}));
}

const { tag } = Astro.props;

// Get all posts with this tag
const posts = await getCollection('blog', ({ data }) => {
	return import.meta.env.PROD ? !data.draft : true;
});

// Filter posts by tag
const tagPosts = posts
	.filter(post => post.data.tags?.includes(tag))
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
---

<BaseLayout
	title={`${tag} - Tag`}
	description={`Browse all posts tagged with ${tag}`}
	layoutType="default"
	contentWidth="default"
	spacing="comfortable"
>
	<Section>
		<h1>{tag}</h1>
		<p>{tagPosts.length} {tagPosts.length === 1 ? 'post' : 'posts'} tagged with {tag}</p>
	</Section>

	<Section>
		<nav>
			{tagPosts.map(post => (
				<PostCard post={post} />
			))}
		</nav>
	</Section>
</BaseLayout> 