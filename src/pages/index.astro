---
import HomeLayout from '../layouts/HomeLayout.astro';
import PostCard from '../components/PostCard.astro';
import PageHeader from '../components/PageHeader.astro';
import StructuredData from '../components/StructuredData.astro';
import { getCollection } from 'astro:content';
import { categories } from '../data/categories';
import { generateStructuredData } from '../utils/structuredData';
import { generateKeywords } from '../utils/seo';

// Get all posts
const posts = await getCollection('blog', ({ data }) => {
	return import.meta.env.PROD ? !data.draft : true;
});

// Sort posts by date
const sortedPosts = posts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Get post counts by category
const postCounts = categories.reduce((acc, category) => {
	acc[category.id] = posts.filter(post => post.data.category?.includes(category.id)).length;
	return acc;
}, {} as Record<string, number>);

// Get post counts by tag
const tagCounts = posts.reduce((acc, post) => {
	post.data.tags?.forEach(tag => {
		acc[tag] = (acc[tag] || 0) + 1;
	});
	return acc;
}, {} as Record<string, number>);

// Generate structured data for home page
const structuredData = generateStructuredData({
	title: 'Welcome to the Strong Vault',
	description: 'Notes on strength, clarity, ritual, and creation — one builder\'s journey through code, craft, and self-mastery.',
	path: '/',
	type: 'website',
	author: 'Antoniwan'
});

// Auto-generate keywords
const allTags = Object.keys(tagCounts);
const allCategories = categories.map(cat => cat.id);
const keywords = generateKeywords(allTags, allCategories);
---

<HomeLayout
	title="Welcome to the Strong Vault"
	description="Notes on strength, clarity, ritual, and creation — one builder's journey through code, craft, and self-mastery."
	path="/"
	keywords={keywords}
>
	<!-- Structured Data -->
	<StructuredData data={structuredData} />

	{/* Hero Section */}
	<div class="max-w-container mx-auto">
		<PageHeader 
			title="Welcome to the Strong Vault"
			description="Notes on strength, clarity, ritual, and creation — one builder's journey through code, craft, and self-mastery."
		/>
	</div>

	{/* Latest Posts Section */}
	<div class="max-w-container mx-auto">
		<div class="space-y-8">
			{sortedPosts.map(post => (
				<PostCard post={post} />
			))}
		</div>
	</div>
</HomeLayout>

<style>
	/* Smooth transitions for dark mode */
	main {
		transition: background-color 150ms cubic-bezier(0.4, 0, 0.2, 1),
					color 150ms cubic-bezier(0.4, 0, 0.2, 1);
	}

	/* Respect reduced motion preferences */
	@media (prefers-reduced-motion: reduce) {
		main {
			transition: none !important;
		}
	}

	@media (max-width: 768px) {
		.hero-section h1 {
			font-size: var(--font-size-3xl);
		}

		.subtitle {
			font-size: var(--font-size-lg);
		}
	}
</style>
