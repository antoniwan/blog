---
import { getCollection } from 'astro:content';
import Icon from './Icon.astro';

interface SearchResult {
  title: string;
  url: string;
  tags: string[];
}

// Get all posts for search
const posts = await getCollection('blog', ({ data }) => {
  return import.meta.env.PROD ? !data.draft : true;
});

// Create search index
const searchIndex: SearchResult[] = posts.map(post => ({
  title: post.data.title,
  url: `/p/${post.id}`,
  tags: post.data.tags || []
}));
---

<form x-data="{ 
  open: false, 
  query: '', 
  results: [], 
  isSearching: false,
  isLoading: true,
  init() {
    this.isLoading = false;
  },
  async handleSearch() {
    if (this.query.length < 3) {
      this.results = [];
      return;
    }
    
    this.isSearching = true;
    // Add your search logic here
    this.isSearching = false;
  }
}">
  <label>
    <input
      type="search"
      x-model="query"
      @input="handleSearch()"
      @click="open = true"
      @click.away="open = false"
      @keydown.escape.window="open = false"
      placeholder="Search posts..."
    />
    <Icon name="search" />
  </label>

  <div x-show="open" style="display: none;" role="listbox">
    <template x-if="isLoading">
      <p>
        <Icon name="loader" class="animate-spin" />
        Loading...
      </p>
    </template>

    <template x-if="!isLoading && isSearching">
      <p>
        <Icon name="loader" class="animate-spin" />
        Searching...
      </p>
    </template>

    <template x-if="!isLoading && !isSearching && query.length > 2 && results.length === 0">
      <p>No results found</p>
    </template>

    <template x-if="!isLoading && !isSearching && results.length > 0">
      <ul>
        <template x-for="result in results" :key="result.url">
          <li>
            <a :href="result.url" @click="open = false">
              <span x-text="result.title"></span>
              <template x-if="result.tags.length > 0">
                <span x-text="result.tags[0]"></span>
              </template>
            </a>
          </li>
        </template>
      </ul>
    </template>
  </div>
</form>

<script define:vars={{ searchIndex }}>
  // Define searchIndex for Alpine.js
  window.searchIndex = searchIndex;
</script> 