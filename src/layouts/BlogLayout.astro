---
import BaseLayout from './BaseLayout.astro';
import Section from '../components/Section.astro';
import FormattedDate from '../components/FormattedDate.astro';

interface Props {
  title: string;
  description?: string;
  pubDate?: Date;
  updatedDate?: Date;
  heroImage?: string;
  readingTime?: number;
  tags?: string[];
  category?: string[];
  subcategory?: string;
  language?: string[];
  contentWidth?: 'narrow' | 'default' | 'wide';
  spacing?: 'compact' | 'default' | 'comfortable';
  // SEO fields
  canonicalUrl?: string;
  ogImage?: string;
  ogImageAlt?: string;
  robots?: {
    index?: boolean;
    follow?: boolean;
    noarchive?: boolean;
    nosnippet?: boolean;
    noimageindex?: boolean;
  };
  // Additional SEO fields
  author?: string;
  keywords?: string[];
  locale?: string;
  // Structured data
  tableOfContents?: {
    items: Array<{
      text: string;
      slug: string;
      depth: number;
    }>;
  };
}

const {
  title,
  description,
  pubDate,
  updatedDate,
  heroImage,
  readingTime,
  tags,
  category,
  subcategory,
  language,
  contentWidth = 'default',
  spacing = 'default',
  canonicalUrl,
  ogImage,
  ogImageAlt,
  robots,
  author,
  keywords,
  locale,
  tableOfContents,
  ...rest
} = Astro.props;

// Generate structured data for blog post
const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: title,
  description: description,
  image: heroImage || ogImage,
  datePublished: pubDate?.toISOString(),
  dateModified: updatedDate?.toISOString(),
  author: {
    '@type': 'Person',
    name: author
  },
  keywords: keywords?.join(', '),
  articleSection: category?.[0],
  articleBody: tableOfContents?.items.map(item => item.text).join(' '),
  wordCount: tableOfContents?.items.reduce((acc, item) => acc + item.text.length, 0),
  timeRequired: readingTime ? `PT${readingTime}M` : undefined
};
---

<BaseLayout
  title={title}
  description={description}
  layoutType="blog"
  pubDate={pubDate}
  updatedDate={updatedDate}
  heroImage={heroImage}
  readingTime={readingTime}
  tags={tags}
  category={category}
  subcategory={subcategory}
  language={language}
  contentWidth={contentWidth}
  spacing={spacing}
  canonicalUrl={canonicalUrl}
  ogImage={ogImage}
  ogImageAlt={ogImageAlt}
  robots={robots}
  author={author}
  keywords={keywords}
  locale={locale}
  {...rest}
>
  <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
  
  <Section>
      <h1>
        {title}
      </h1>
      {description && (
        <p>
          {description}
        </p>
      )}
        {pubDate && (
          <time datetime={pubDate.toISOString()}>
            <FormattedDate date={pubDate} format="long" />
          </time>
        )}
        
        {readingTime && (
          <span>
            {readingTime} min read
          </span>
        )}
        
        {category && category.length > 0 && (
          <span>
            <a href={`/category/${category[0]}/`}>
              {category[0]}
            </a>
          </span>
        )}
        
        {tags && tags.length > 0 && (
            {tags.map(tag => (
              <a href={`/tag/${tag}/`}>
                {tag}
              </a>
            ))}
        )}

      {heroImage && (
          <img 
            src={heroImage} 
            alt={title}
            loading="eager"
          />
      )}
  </Section>
  
  <Section>
    <slot />
  </Section>

</BaseLayout>